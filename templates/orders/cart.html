{% extends 'core/base.html' %}

{% block title %}Shopping Cart - Martabak PANDAN WANGI{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Shopping Cart</h1>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div id="cart-items">
                        <!-- Cart items will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">Order Summary</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">Rp 0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total:</span>
                        <span class="fw-bold" id="cart-total">Rp 0</span>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{% url 'checkout' %}" class="btn btn-dark" id="checkout-btn">Proceed to Checkout</a>
                        <a href="{% url 'product_list' %}" class="btn btn-outline-dark">Continue Shopping</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Load cart items
        loadCartItems();
        
        // Update checkout button state
        updateCheckoutButton();
        
        // Function to load cart items
        function loadCartItems() {
            const cart = window.getCartItems();
            const cartItemsContainer = $('#cart-items');
            cartItemsContainer.empty();
            
            if (Object.keys(cart).length === 0) {
                cartItemsContainer.html(`
                    <div class="text-center py-5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-cart mb-3" viewBox="0 0 16 16">
                            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        <h4>Your cart is empty</h4>
                        <p>Looks like you haven't added any items to your cart yet.</p>
                        <a href="{% url 'product_list' %}" class="btn btn-dark">Browse Products</a>
                    </div>
                `);
            } else {
                let itemsHtml = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                for (const id in cart) {
                    const item = cart[id];
                    const itemTotal = item.price * item.quantity;
                    
                    itemsHtml += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${item.image}" alt="${item.name}" class="img-thumbnail me-3" style="width: 60px; height: 60px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/60?text=${item.name}'">
                                    <div>
                                        <h6 class="mb-0">${item.name}</h6>
                                    </div>
                                </div>
                            </td>
                            <td>Rp ${item.price}</td>
                            <td>
                                <div class="input-group" style="width: 120px;">
                                    <button class="btn btn-outline-dark btn-sm" type="button" onclick="decrementQuantity(${item.id})">-</button>
                                    <input type="number" class="form-control text-center" value="${item.quantity}" min="1" onchange="updateQuantity(${item.id}, this.value)">
                                    <button class="btn btn-outline-dark btn-sm" type="button" onclick="incrementQuantity(${item.id})">+</button>
                                </div>
                            </td>
                            <td>Rp ${itemTotal}</td>
                            <td>
                                <button class="btn btn-sm" onclick="removeFromCart(${item.id}); loadCartItems();">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                itemsHtml += `
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <button class="btn btn-outline-dark" onclick="clearCart(); loadCartItems();">Clear Cart</button>
                    </div>
                `;
                
                cartItemsContainer.html(itemsHtml);
            }
            
            // Update totals
            updateCartTotals();
        }
        
        // Function to update cart totals
        function updateCartTotals() {
            const subtotal = parseFloat(window.getCartTotal());
            const total = subtotal;
            
            $('#cart-subtotal').text(`Rp ${subtotal}`);
            $('#cart-total').text(`Rp ${total}`);
        }
        
        // Function to update checkout button state
        function updateCheckoutButton() {
            const cartEmpty = Object.keys(window.getCartItems()).length === 0;
            $('#checkout-btn').prop('disabled', cartEmpty);
            if (cartEmpty) {
                $('#checkout-btn').addClass('disabled');
            } else {
                $('#checkout-btn').removeClass('disabled');
            }
        }
        
        // Add global functions for quantity management
        window.decrementQuantity = function(productId) {
            const cart = window.getCartItems();
            if (cart[productId] && cart[productId].quantity > 1) {
                updateCartQuantity(productId, cart[productId].quantity - 1);
                loadCartItems();
            }
        };
        
        window.incrementQuantity = function(productId) {
            const cart = window.getCartItems();
            if (cart[productId]) {
                updateCartQuantity(productId, cart[productId].quantity + 1);
                loadCartItems();
            }
        };
        
        window.updateQuantity = function(productId, quantity) {
            updateCartQuantity(productId, parseInt(quantity));
            loadCartItems();
        };
    });
</script>
{% endblock %}
{% endblock %}
